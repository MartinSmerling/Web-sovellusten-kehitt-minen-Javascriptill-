<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="utf-8" />
<title>Workshop 7 – AJAX & XML</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body { font-family: Arial, Helvetica, sans-serif; margin:20px; background:#f7f9fc; color:#222; }
  h1 { color:#004aad }
  button { background:#004aad; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin:6px 4px 12px 0;}
  button:hover{background:#003580}
  #quotes, #table, #newsList { background:#eef4ff; padding:10px; border-radius:6px; min-height:40px }
  table { width:100%; border-collapse:collapse; margin-top:10px }
  th, td { padding:10px; border:1px solid #ddd }
  th { background:#004aad; color:#fff; text-align:left }
  .log { font-size:0.9em; color:#666; margin-top:8px; }
  small { color:#666 }
</style>
</head>
<body>
  <h1>Workshop 7: AJAX ja XML</h1>

  <section>
    <h2>Exercise 1: Upotetun XML:n parsinta</h2>
    <button id="btnParseEmbedded">Näytä upotettu XML (parseData)</button>
    <div id="output1"></div>
  </section>

  <hr>

  <section>
    <h2>Exercise 2: AJAX-kutsu XML-tiedostoon</h2>
    <button id="btnLoadRaw">Lataa XML sisältö (raw)</button>
    <div id="quotes" style="white-space:pre-wrap;"></div>
  </section>

  <hr>

  <section>
    <h2>Exercise 3: Lataa ja näytä taulukkona</h2>
    <button id="btnLoadParse">Lataa ja näytä taulukkona</button>
    <div id="table"></div>
  </section>

  <hr>

  <section>
    <h2>Exercise 4: Uutissyöte (esimerkki)</h2>
    <button id="btnLoadNews">Lataa uutiset (RSS)</button>
    <ul id="newsList"></ul>
  </section>

  <hr>

  <script>
  function parseXmlString(str) {
    if (!str) return null;
    try {
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(str, "application/xml");
      if (xmlDoc.getElementsByTagName("parsererror").length) {
        console.error("XML parse error:", xmlDoc.getElementsByTagName("parsererror")[0].textContent);
        return null;
      }
      return xmlDoc;
    } catch (e) {
      console.error("XML parser error", e);
      return null;
    }
  }

  const embeddedXMLString = `<?xml version="1.0" encoding="UTF-8"?>
  <quotes>
    <quote>
      <text>I'm not concerned about all hell breaking loose, but that a PART of hell will break loose... it'll be much harder to detect.</text>
      <author>George Carlin</author>
    </quote>
    <quote>
      <text>The biggest problem with every art is by the use of appearance to create a loftier reality.</text>
      <author>Johann Wolfgang von Goethe</author>
    </quote>
  </quotes>`;

  const embeddedXMLDoc = parseXmlString(embeddedXMLString);

  document.getElementById('btnParseEmbedded').addEventListener('click', function() {
    const out = document.getElementById('output1');
    out.innerHTML = '';
    const xml = embeddedXMLDoc;
    if (!xml) { out.textContent = "Upotetun XML:n parsiminen epäonnistui."; return; }
    const quotes = xml.getElementsByTagName('quote');
    let html = '';
    for (let i=0;i<quotes.length;i++){
      const t = quotes[i].getElementsByTagName('text')[0]?.textContent || '';
      const a = quotes[i].getElementsByTagName('author')[0]?.textContent || '';
      html += `<p><strong>${a}:</strong> "${t}"</p>`;
    }
    out.innerHTML = html;
    console.log("parseData: upotettu XML parsittu, rivit:", quotes.length);
  });

  function fetchXmlFile(filepath) {
    return new Promise((resolve) => {
      console.log("fetchXmlFile: yritetään hakea", filepath);
      fetch(filepath).then(response => {
        if (!response.ok) {
          console.warn("fetch: response not ok", response.status, response.statusText);
          resolve(null);
          return;
        }
        return response.text();
      }).then(text => {
        if (!text) { resolve(null); return; }
        const xmlDoc = parseXmlString(text);
        if (xmlDoc) {
          resolve(xmlDoc);
        } else {
          resolve(null);
        }
      }).catch(err=>{
        console.warn("fetchXmlFile error:", err);
        resolve(null);
      });
    });
  }

  document.getElementById('btnLoadRaw').addEventListener('click', async function(){
    const quotesDiv = document.getElementById('quotes');
    quotesDiv.textContent = "Ladataan...";
    const xmlDoc = await fetchXmlFile('famous-quotes.xml');
    if (xmlDoc) {
      const serializer = new XMLSerializer();
      const xmlString = serializer.serializeToString(xmlDoc);
      quotesDiv.textContent = xmlString;
      console.log("Exercise2: ladattiin famous-quotes.xml ja serialisoitiin.");
    } else {
      quotesDiv.textContent = embeddedXMLString;
      console.log("Exercise2: ei löytynyt famous-quotes.xml, näytetään upotettu fallback-XML.");
    }
  });

  document.getElementById('btnLoadParse').addEventListener('click', async function(){
    const tableDiv = document.getElementById('table');
    tableDiv.innerHTML = "Ladataan ja parsitaan...";
    const xmlDoc = await fetchXmlFile('famous-quotes.xml');
    const xmlToUse = xmlDoc || embeddedXMLDoc;
    if (!xmlToUse) {
      tableDiv.textContent = "XML-dataa ei saatavilla (eikä fallback toimi). Tarkista konsolista lisää.";
      console.error("loadAndParseXML: ei löytynyt xmlDoc eikä fallback.");
      return;
    }

    const quotes = xmlToUse.getElementsByTagName('quote');
    if (!quotes.length) {
      tableDiv.textContent = "XML ei sisällä <quote> elementtejä.";
      console.warn("loadAndParseXML: quotes.length == 0");
      return;
    }

    let html = '<table><thead><tr><th>Quote</th><th>Author</th></tr></thead><tbody>';
    for (let i=0;i<quotes.length;i++){
      const t = quotes[i].getElementsByTagName('text')[0]?.textContent || 'N/A';
      const a = quotes[i].getElementsByTagName('author')[0]?.textContent || 'Unknown';
      html += `<tr><td>${escapeHtml(t)}</td><td>${escapeHtml(a)}</td></tr>`;
    }
    html += '</tbody></table>';
    tableDiv.innerHTML = html;
    console.log("loadAndParseXML: parsittu ja esitetty taulukkona, rivit:", quotes.length);
  });

  document.getElementById('btnLoadNews').addEventListener('click', async function(){
    const newsList = document.getElementById('newsList');
    newsList.innerHTML = '<li>Ladataan...</li>';
    const localXml = await fetchXmlFile('uutiset.xml');
    let xmlDoc = localXml;
    if (!xmlDoc) {
      try {
        const resp = await fetch('https://meijastiina.github.io/news_rss_topstories.xml');
        if (resp.ok) {
          const text = await resp.text();
          xmlDoc = parseXmlString(text);
        }
      } catch(e){
        console.warn('External news fetch failed', e);
      }
    }
    if (!xmlDoc) {
      newsList.innerHTML = '<li>Uutissyötettä ei voitu ladata (CORS/verkko/puuttuva tiedosto). Katso konsolista lisätietoja.</li>';
      return;
    }
    const items = xmlDoc.getElementsByTagName('item');
    if (!items.length) { newsList.innerHTML = '<li>Syöte ei sisällä <item>-elementtejä.</li>'; return; }
    newsList.innerHTML = '';
    for (let i=0;i<items.length;i++){
      const titleNode = items[i].getElementsByTagName('title')[0];
      const linkNode = items[i].getElementsByTagName('link')[0];
      const title = titleNode ? titleNode.textContent : 'No title';
      const link = linkNode ? linkNode.textContent : '#';
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = link;
      a.target = '_blank';
      a.textContent = title;
      li.appendChild(a);
      newsList.appendChild(li);
    }
    console.log('loadNews: ladattiin ja listattiin', items.length, 'uutista');
  });


  function escapeHtml(str) {
    if (!str && str !== '') return '';
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }

  console.log('%cINFO: Jos AJAX:in lataus epäonnistuu, käytä Live Serveriä (VS Code) tai python -m http.server projektikansiossa.', 'color:teal');

  </script>

  <script type="application/xml" id="embedded-xml" style="display:none;">
  <?xml version="1.0" encoding="UTF-8"?>
  <quotes>
    <quote>
      <text>I'm not concerned about all hell breaking loose, but that a PART of hell will break loose... it'll be much harder to detect.</text>
      <author>George Carlin</author>
    </quote>
    <quote>
      <text>The biggest problem with every art is by the use of appearance to create a loftier reality.</text>
      <author>Johann Wolfgang von Goethe</author>
    </quote>
  </quotes>
  </script>
</body>
</html>
